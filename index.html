<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지도 위 랜덤 시간 & 이미지 마커</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body, html {
            height: 100%; margin: 0; overflow: hidden;
            font-family: sans-serif; cursor: default;
        }
        #map {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        .ui-element {
            position: absolute; z-index: 10;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px; border-radius: 5px; color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        #clock-wrapper { top: 20px; right: 20px; }
        .mini-digit, .mini-colon {
            font-size: 32px; font-weight: bold; line-height: 1; padding: 0 2px;
            font-family: 'Courier New', Courier, monospace;
        }
        #location-btn {
            top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; width: 48px; height: 48px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: background 0.2s;
        }
        #location-btn:hover { background: rgba(0, 0, 0, 0.7); }
        #location-btn.active { background-color: #007bff; border-color: #007bff; }
        #image-bar-wrapper {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 10;
            display: inline-flex; align-items: center; gap: 10px;
            background-color: rgba(0, 0, 0, 0.6); padding: 10px;
            border-radius: 12px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        .image-slot {
            width: 70px; height: 70px; border: 2px solid #4CAF50; border-radius: 8px;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
        }
        .image-slot img { width: 100%; height: 100%; object-fit: cover; }
        .image-slot.selected {
            border-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.8);
        }
        .add-image-btn {
            width: 70px; height: 70px; border: 2px dashed rgba(255, 255, 255, 0.5); background-color: transparent;
            color: rgba(255, 255, 255, 0.7); border-radius: 8px; font-size: 40px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .add-image-btn:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
        .image-slot .delete-icon {
            position: absolute; top: 4px; right: 4px; background-color: rgba(255, 0, 0, 0.8); color: white;
            font-size: 14px; width: 20px; height: 20px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
        }
        .image-slot:hover .delete-icon { opacity: 1; }
        body.custom-cursor { cursor: none !important; }
        #custom-cursor-img {
            position: fixed; pointer-events: none; z-index: 10000;
            width: 60px; height: 60px; object-fit: contain;
            transform: translate(-50%, -50%); display: none;
        }
        .image-map-marker {
            width: 60px; height: 60px; background-size: contain; background-repeat: no-repeat;
            background-position: center; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            cursor: pointer; position: relative;
        }
        .image-map-marker .delete-marker-icon {
            position: absolute; top: -8px; right: -8px; background-color: rgba(255, 0, 0, 0.8);
            color: white; font-size: 12px; width: 18px; height: 18px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            visibility: hidden; opacity: 0; transition: opacity 0.2s;
        }
        .image-map-marker:hover .delete-marker-icon { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="clock-wrapper" class="ui-element">
        <span class="mini-digit" id="hour1">00</span>
        <span class="mini-colon">:</span>
        <span class="mini-digit" id="minute1">00</span>
    </div>

    <button id="location-btn" title="내 위치 추적">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
    </button>
    
    <div id="image-bar-wrapper"></div>
    <input type="file" id="image-uploader" accept="image/*" style="display: none;">
    <img id="custom-cursor-img" src="" alt="커서 이미지">

    <script>
        // 전역 변수 선언
        const clockHourEl = document.getElementById('hour1');
        const clockMinuteEl = document.getElementById('minute1');
        const locationBtn = document.getElementById('location-btn');
        const imageBarWrapper = document.getElementById('image-bar-wrapper');
        const imageUploader = document.getElementById('image-uploader');
        const customCursorImg = document.getElementById('custom-cursor-img');
        const MAX_IMAGES = 5;
        let map, userMarker, geolocationWatchId = null, currentSelectedImage = null;

        // --- 🔥 1. 시계 관련 함수 (버그 수정됨) ---
        function initializeClock(timeZone) {
            const dateFormatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: timeZone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const currentDate = dateFormatter.format(new Date()); // 예: "2025-10-08"
            const storageKey = `randomTimeData_${timeZone}`;
            const storedData = JSON.parse(localStorage.getItem(storageKey));
            let randomTime;

            if (!storedData || storedData.date !== currentDate) {
                // 저장된 데이터가 없거나, 저장된 날짜가 오늘과 다르면
                const randomHour = Math.floor(Math.random() * 24);
                const randomMinute = Math.floor(Math.random() * 60);
                const format = num => num.toString().padStart(2, '0');
                randomTime = `${format(randomHour)}:${format(randomMinute)}`;
                
                // 🔥 수정된 부분: currentDate를 함께 정확히 저장합니다.
                localStorage.setItem(storageKey, JSON.stringify({ time: randomTime, date: currentDate }));
            } else {
                // 저장된 날짜가 오늘과 같으면, 기존 시간을 사용
                randomTime = storedData.time;
            }
            const [hour, minute] = randomTime.split(':');
            clockHourEl.textContent = hour;
            clockMinuteEl.textContent = minute;
        }

        // --- (이하 나머지 코드는 이전과 동일합니다) ---
        function initMap(){map=L.map("map").setView([37.566826,126.9786567],10),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),map.on("click",e=>{currentSelectedImage&&placeImageMarker(e.latlng,currentSelectedImage)}),loadAndRenderImageMarkers()}locationBtn.addEventListener("click",()=>{geolocationWatchId?(navigator.geolocation.clearWatch(geolocationWatchId),geolocationWatchId=null,locationBtn.classList.remove("active"),userMarker&&(map.removeLayer(userMarker),userMarker=null),alert("위치 추적을 중지했습니다.")):navigator.geolocation?(alert("실시간 위치 추적을 시작합니다."),locationBtn.classList.add("active"),geolocationWatchId=navigator.geolocation.watchPosition(e=>{const t=e.coords.latitude,o=e.coords.longitude,a=[t,o];userMarker?userMarker.setLatLng(a):userMarker=L.marker(a).addTo(map).bindPopup("현재 위치").openPopup(),map.setView(a,16)},e=>{console.error("Geolocation 오류:",e),alert("현재 위치를 가져올 수 없습니다. 권한을 확인해주세요."),locationBtn.classList.remove("active")},{enableHighAccuracy:!0})):alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.")});function loadSavedImages(){return JSON.parse(localStorage.getItem("savedImages"))||[]}function saveSavedImages(e){localStorage.setItem("savedImages",JSON.stringify(e))}function renderImageBar(){imageBarWrapper.innerHTML="";const e=loadSavedImages();e.forEach((t,o)=>{const a=document.createElement("div");a.className="image-slot",a.innerHTML=`\n                    <img src="${t}" alt="저장된 이미지 ${o+1}">\n                    <div class="delete-icon" title="삭제">X</div>\n                `,a.addEventListener("click",()=>{selectImageForCursor(t,a)}),a.querySelector(".delete-icon").addEventListener("click",a=>{a.stopPropagation(),confirm("이 이미지를 삭제하시겠습니까?")&&(e.splice(o,1),saveSavedImages(e),renderImageBar(),resetImageCursor())}),imageBarWrapper.appendChild(a)}),e.length<MAX_IMAGES&&(()=>{const e=document.createElement("button");e.className="add-image-btn",e.textContent="+",e.title="이미지 추가",e.addEventListener("click",()=>{imageUploader.click()}),imageBarWrapper.appendChild(e)})()}imageUploader.addEventListener("change",e=>{const t=e.target.files[0];if(t){const o=new FileReader;o.onload=t=>{const o=loadSavedImages();o.length<MAX_IMAGES&&(o.push(t.target.result),saveSavedImages(o),renderImageBar())},o.readAsDataURL(t)}e.target.value=""});function selectImageForCursor(e,t){document.querySelectorAll(".image-slot.selected").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),currentSelectedImage=e,customCursorImg.src=e,customCursorImg.style.display="block",document.body.classList.add("custom-cursor"),document.addEventListener("mousemove",updateCustomCursorPosition),document.addEventListener("keydown",handleEscKey),document.body.addEventListener("click",handleClickOutsideMap)}function updateCustomCursorPosition(e){customCursorImg.style.left=`${e.clientX}px`,customCursorImg.style.top=`${e.clientY}px`}function handleEscKey(e){"Escape"===e.key&&resetImageCursor()}function handleClickOutsideMap(e){map.getContainer().contains(e.target)||imageBarWrapper.contains(e.target)||e.target.closest("#location-btn")||resetImageCursor()}function resetImageCursor(){currentSelectedImage=null,customCursorImg.src="",customCursorImg.style.display="none",document.body.classList.remove("custom-cursor"),document.removeEventListener("mousemove",updateCustomCursorPosition),document.removeEventListener("keydown",handleEscKey),document.body.removeEventListener("click",handleClickOutsideMap),document.querySelectorAll(".image-slot.selected").forEach(e=>{e.classList.remove("selected")})}function placeImageMarker(e,t){const o=JSON.parse(localStorage.getItem("imageMapMarkers"))||[];o.push({lat:e.lat,lng:e.lng,img:t}),localStorage.setItem("imageMapMarkers",JSON.stringify(o)),renderImageMarkers()}function renderImageMarkers(){map&&map.imageMarkerLayers&&map.imageMarkerLayers.forEach(e=>map.removeLayer(e)),map.imageMarkerLayers=[];const e=JSON.parse(localStorage.getItem("imageMapMarkers"))||[];e.forEach((t,o)=>{const a=`\n                    <div class="image-map-marker" style="background-image: url('${t.img}');">\n                        <div class="delete-marker-icon" data-index="${o}" title="마커 삭제">X</div>\n                    </div>\n                `,r=L.divIcon({html:a,className:"custom-image-icon",iconSize:[60,60],iconAnchor:[30,30]}),n=L.marker([t.lat,t.lng],{icon:r}).addTo(map);map.imageMarkerLayers.push(n),n.getElement().querySelector(".delete-marker-icon").addEventListener("click",t=>{t.stopPropagation(),confirm("이 이미지 마커를 지도에서 삭제하시겠습니까?")&&deleteImageMarker(o)})})}function deleteImageMarker(e){let t=JSON.parse(localStorage.getItem("imageMapMarkers"))||[];t.splice(e,1),localStorage.setItem("imageMapMarkers",JSON.stringify(t)),renderImageMarkers()}function loadAndRenderImageMarkers(){map&&renderImageMarkers()}document.addEventListener("DOMContentLoaded",()=>{initMap(),initializeClock("Asia/Seoul"),renderImageBar()});
    </script>
</body>
</html>
