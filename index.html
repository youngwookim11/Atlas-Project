<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시간 기록 지도</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body, html {
            height: 100%; margin: 0; overflow: hidden;
            font-family: sans-serif; cursor: default;
        }
        #map {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        .ui-element {
            position: absolute; z-index: 10;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px; border-radius: 5px; color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        #clock-wrapper { top: 20px; right: 20px; }
        .mini-digit, .mini-colon {
            font-size: 32px; font-weight: bold; line-height: 1; padding: 0 2px;
            font-family: 'Courier New', Courier, monospace;
        }
        #image-bar-wrapper {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 10;
            display: inline-flex; align-items: center; gap: 10px;
            background-color: rgba(0, 0, 0, 0.6); padding: 10px;
            border-radius: 12px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        .image-slot {
            width: 70px; height: 70px; border: 2px solid #4CAF50; border-radius: 8px;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
        }
        .image-slot img { width: 100%; height: 100%; object-fit: cover; }
        .image-slot.selected {
            border-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.8);
        }
        .add-image-label {
            width: 70px; height: 70px;
            border: 2px dashed rgba(255, 255, 255, 0.5); background-color: transparent;
            color: rgba(255, 255, 255, 0.7); border-radius: 8px; font-size: 40px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .add-image-label:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
        .image-slot .delete-icon {
            position: absolute; top: 4px; right: 4px; background-color: rgba(255, 0, 0, 0.8); color: white;
            font-size: 14px; width: 20px; height: 20px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
        }
        .image-slot:hover .delete-icon { opacity: 1; }
        body.custom-cursor { cursor: none !important; }
        #custom-cursor-img {
            position: fixed; pointer-events: none; z-index: 10000;
            width: 60px; height: 60px; object-fit: contain;
            transform: translate(-50%, -50%); display: none;
        }

        /* --- 🔥 지도 마커 스타일 수정 --- */
        .image-marker-container {
            text-align: center;
        }
        .image-map-marker {
            width: 60px; height: 60px;
            background-size: contain; background-repeat: no-repeat;
            background-position: center; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            cursor: pointer; position: relative;
        }
        .marker-timestamp {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 3px;
            /* 위치를 이미지 아래로 조정 */
            position: relative;
            top: 2px;
            white-space: nowrap; /* 시간이 한 줄로 보이도록 */
        }
        .image-map-marker .delete-marker-icon {
            position: absolute; top: -8px; right: -8px; background-color: rgba(255, 0, 0, 0.8);
            color: white; font-size: 12px; width: 18px; height: 18px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            visibility: hidden; opacity: 0; transition: opacity 0.2s;
        }
        .image-map-marker:hover .delete-marker-icon { visibility: visible; opacity: 1; }
        .visually-hidden {
            position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0;
            overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="clock-wrapper" class="ui-element">
        <span class="mini-digit" id="hour1">00</span>
        <span class="mini-colon">:</span>
        <span class="mini-digit" id="minute1">00</span>
    </div>
    <div id="image-bar-wrapper"></div>
    <input type="file" id="image-uploader" class="visually-hidden" accept="image/*">
    <img id="custom-cursor-img" src="" alt="커서 이미지">

    <script>
        const clockHourEl = document.getElementById('hour1'), clockMinuteEl = document.getElementById('minute1'), imageBarWrapper = document.getElementById('image-bar-wrapper'), imageUploader = document.getElementById('image-uploader'), customCursorImg = document.getElementById('custom-cursor-img'), MAX_IMAGES = 5;
        let map, userMarker, currentSelectedImage = null;

        // 시계, 지도 관련 함수 (이전과 동일)
        function initializeClock(e){const t=new Intl.DateTimeFormat("en-CA",{timeZone:e,year:"numeric",month:"2-digit",day:"2-digit"}),o=t.format(new Date),a=`randomTimeData_${e}`,r=JSON.parse(localStorage.getItem(a));let n;if(r&&r.date===o)n=r.time;else{const t=Math.floor(24*Math.random()),o=Math.floor(60*Math.random()),r=e=>e.toString().padStart(2,"0");n=`${r(t)}:${r(o)}`,localStorage.setItem(a,JSON.stringify({time:n,date:o}))}const[i,s]=n.split(":");clockHourEl.textContent=i,clockMinuteEl.textContent=s}
        function initMap(){map=L.map("map").setView([37.566826,126.9786567],10),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),map.on("click",e=>{currentSelectedImage&&placeImageMarker(e.latlng,currentSelectedImage)}),loadAndRenderImageMarkers()}

        // 자동 위치 추적 함수
        function startAutoTracking(){navigator.geolocation&&navigator.geolocation.watchPosition(e=>{const t=e.coords.latitude,o=e.coords.longitude,a=[t,o];userMarker?userMarker.setLatLng(a):userMarker=L.marker(a).addTo(map).bindPopup("현재 위치").openPopup(),map.panTo(a)},e=>{console.error("Geolocation 오류:",e.message)},{enableHighAccuracy:!0,maximumAge:0,timeout:5e3})}
        
        // 이미지 바, 커서 관련 함수들 (이전과 동일)
        function loadSavedImages(){return JSON.parse(localStorage.getItem("savedImages"))||[]}
        function saveSavedImages(e){localStorage.setItem("savedImages",JSON.stringify(e))}
        function renderImageBar(){imageBarWrapper.innerHTML="";const e=loadSavedImages();e.forEach((t,o)=>{const a=document.createElement("div");a.className="image-slot",a.innerHTML=`<img src="${t}" alt="저장된 이미지 ${o+1}"><div class="delete-icon" title="삭제">X</div>`,a.addEventListener("click",()=>{selectImageForCursor(t,a)}),a.querySelector(".delete-icon").addEventListener("click",e=>{e.stopPropagation(),confirm("이 이미지를 삭제하시겠습니까?")&&(images.splice(o,1),saveSavedImages(images),renderImageBar(),resetImageCursor())}),imageBarWrapper.appendChild(a)}),e.length<MAX_IMAGES&&(()=>{const e=document.createElement("label");e.className="add-image-label",e.htmlFor="image-uploader",e.textContent="+",e.title="이미지 추가",imageBarWrapper.appendChild(e)})()}
        function handleFileSelect(event){const file=event.target.files[0];if(!file){return}const reader=new FileReader;reader.onload=function(e){const images=loadSavedImages();if(images.length<MAX_IMAGES){images.push(e.target.result);saveSavedImages(images);renderImageBar()}};reader.readAsDataURL(file);event.target.value=""}
        imageUploader.addEventListener("change",handleFileSelect);
        function selectImageForCursor(e,t){document.querySelectorAll(".image-slot.selected").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),currentSelectedImage=e,customCursorImg.src=e,customCursorImg.style.display="block",document.body.classList.add("custom-cursor"),document.addEventListener("mousemove",updateCustomCursorPosition),document.addEventListener("keydown",handleEscKey),document.body.addEventListener("click",handleClickOutsideMap)}
        function updateCustomCursorPosition(e){customCursorImg.style.left=`${e.clientX}px`,customCursorImg.style.top=`${e.clientY}px`}
        function handleEscKey(e){"Escape"===e.key&&resetImageCursor()}
        function handleClickOutsideMap(e){map.getContainer().contains(e.target)||imageBarWrapper.contains(e.target)||resetImageCursor()}
        function resetImageCursor(){currentSelectedImage=null,customCursorImg.src="",customCursorImg.style.display="none",document.body.classList.remove("custom-cursor"),document.removeEventListener("mousemove",updateCustomCursorPosition),document.removeEventListener("keydown",handleEscKey),document.removeEventListener("click",handleClickOutsideMap),document.querySelectorAll(".image-slot.selected").forEach(e=>{e.classList.remove("selected")})}

        // --- 🔥 마커 관련 함수 (수정됨) ---
        function placeImageMarker(latlng, imgData) {
            const imageMarkers = JSON.parse(localStorage.getItem('imageMapMarkers')) || [];
            // 현재 시간을 HH:MM 형식으로 가져오기
            const now = new Date();
            const timestamp = now.toTimeString().substring(0, 5); // 예: "14:30"
            
            imageMarkers.push({
                lat: latlng.lat,
                lng: latlng.lng,
                img: imgData,
                time: timestamp // 시간 정보 추가
            });
            localStorage.setItem('imageMapMarkers', JSON.stringify(imageMarkers));
            renderImageMarkers();
        }

        function renderImageMarkers() {
            if (map && map.imageMarkerLayers) {
                map.imageMarkerLayers.forEach(layer => map.removeLayer(layer));
            }
            map.imageMarkerLayers = [];

            const imageMarkers = JSON.parse(localStorage.getItem('imageMapMarkers')) || [];
            imageMarkers.forEach((markerData, index) => {
                // 아이콘 HTML에 시간 표시 부분 추가
                const iconHtml = `
                    <div class="image-marker-container">
                        <div class="image-map-marker" style="background-image: url('${markerData.img}');">
                            <div class="delete-marker-icon" data-index="${index}" title="마커 삭제">X</div>
                        </div>
                        <div class="marker-timestamp">${markerData.time}</div>
                    </div>
                `;
                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-image-icon-wrapper', // wrapper 클래스
                    iconSize: [60, 75], // 이미지와 시간 영역을 포함한 전체 크기
                    iconAnchor: [30, 75] // 아이콘의 가장 아래 중앙을 기준으로 위치 잡기
                });

                const marker = L.marker([markerData.lat, markerData.lng], { icon: customIcon }).addTo(map);
                map.imageMarkerLayers.push(marker);

                marker.getElement().querySelector('.delete-marker-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('이 이미지 마커를 지도에서 삭제하시겠습니까?')) {
                        deleteImageMarker(index);
                    }
                });
            });
        }

        function deleteImageMarker(indexToDelete) {
            let imageMarkers = JSON.parse(localStorage.getItem('imageMapMarkers')) || [];
            imageMarkers.splice(indexToDelete, 1);
            localStorage.setItem('imageMapMarkers', JSON.stringify(imageMarkers));
            renderImageMarkers();
        }

        function loadAndRenderImageMarkers() {
            if (map) renderImageMarkers();
        }
        
        document.addEventListener("DOMContentLoaded",()=>{
            initMap();
            initializeClock("Asia/Seoul");
            renderImageBar();
            startAutoTracking();
        });
    </script>
</body>
</html>
